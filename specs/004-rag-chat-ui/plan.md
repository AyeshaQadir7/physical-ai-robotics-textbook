# Implementation Plan: Integrate RAG Backend with Docusaurus Frontend

**Branch**: `004-rag-chat-ui` | **Date**: 2025-12-26 | **Spec**: [spec.md](spec.md)
**Status**: Architecture Planning Phase | **Target Audience**: Full-stack engineers

---

## Summary

Build an embedded chatbot React component for the Docusaurus robotics textbook that queries the FastAPI RAG Agent API (Spec 3). The chatbot allows readers to ask questions about book content, receives grounded responses with source citations, and supports text selection-scoped queries. Implementation uses Docusaurus's built-in React component system, HTTP/JSON communication with the existing FastAPI backend, and client-side configuration management for local/production environments.

**Core Architecture**:
- Frontend: React component in Docusaurus, sidebar/modal UI
- Backend: Existing FastAPI `/chat` endpoint (Spec 3)
- Communication: HTTP fetch with JSON payloads
- Data: Session-based conversation history (client-side only)

---

## Technical Context

**Language/Version**: TypeScript 5.0+ (via Docusaurus), React 18+
**Primary Dependencies**:
- React 18+ (Docusaurus built-in)
- Fetch API (native browser)
- Docusaurus swizzle system for component injection
- Optional: React Query or SWR for API state management

**Storage**: None (session-only conversation history in React state)
**Testing**: Jest + React Testing Library (standard Docusaurus setup)
**Target Platform**: Modern browsers (Chrome, Firefox, Safari, Edge 2021+)
**Project Type**: Web frontend component (integrates into existing Docusaurus site)
**Performance Goals**:
- API response displayed within 5 seconds of user submission
- Chatbot opens/closes in <200ms
- Selected text capture <50ms

**Constraints**:
- No authentication (uses backend security)
- No persistent storage (session-only)
- Must work with existing Docusaurus build process
- Zero breaking changes to textbook site

**Scale/Scope**:
- Single chatbot component
- Up to 50 questions per session
- Conversation history cleared on page reload

---

## Constitution Check

**Gate: Spec-Driven Development**
- ✅ PASS: Feature specified before implementation (SPEC-4 complete)
- ✅ PASS: Architecture decisions will be documented in ADRs
- ✅ PASS: No implementation before spec approval

**Gate: Book as Authoritative Source**
- ✅ PASS: All responses come from RAG Agent API (Spec 3)
- ✅ PASS: Chatbot displays sources and citations from backend
- ✅ PASS: No external knowledge injection permitted

**Gate: RAG Mandate**
- ✅ PASS: Chatbot only queries FastAPI RAG endpoint
- ✅ PASS: No direct LLM calls from frontend
- ✅ PASS: Response grounding enforced by backend

**Gate: Traceability**
- ✅ PASS: All sources cited (URL + page title from response)
- ✅ PASS: Conversation logs can be captured for auditing
- ✅ PASS: User-selected text included in query context

**Gate: Technology Stack Compliance**
- ✅ PASS: React/TypeScript for frontend (Docusaurus mandated)
- ✅ PASS: FastAPI backend already specified (Spec 3)
- ✅ PASS: HTTP/JSON communication (standard REST)
- ✅ PASS: No unauthorized tech stack additions

**Constitution Violations**: None
**Status**: ✅ APPROVED for Phase 0 Research

---

## Project Structure

### Documentation (this feature)

```text
specs/004-rag-chat-ui/
├── spec.md              # Feature specification (COMPLETE)
├── plan.md              # This file (architecture and design)
├── research.md          # Phase 0: Technology research and best practices
├── data-model.md        # Phase 1: Entity definitions
├── contracts/           # Phase 1: API contracts (OpenAPI)
│   ├── chatbot-api.openapi.yaml
│   └── message-schema.json
├── quickstart.md        # Phase 1: Developer setup guide
├── checklists/
│   └── requirements.md  # Quality validation
└── tasks.md             # Phase 2: Executable tasks (generated by /sp.tasks)
```

### Source Code (repository)

```text
frontend/
├── docusaurus.config.ts              # Docusaurus config (will add RAG_AGENT_URL)
├── src/
│   ├── components/
│   │   ├── ChatBot/                  # NEW: Chatbot component
│   │   │   ├── ChatBot.tsx           # Main component
│   │   │   ├── ChatBot.module.css    # Styles
│   │   │   ├── useChat.ts            # Hook for API communication
│   │   │   ├── useTextSelection.ts   # Hook for text capture
│   │   │   └── __tests__/
│   │   │       ├── ChatBot.test.tsx
│   │   │       ├── useChat.test.ts
│   │   │       └── useTextSelection.test.ts
│   │   └── DocLayout.tsx             # MODIFIED: Add ChatBot to layout
│   ├── services/
│   │   ├── ragClient.ts              # RAG API HTTP client
│   │   └── __tests__/
│   │       └── ragClient.test.ts
│   └── types/
│       └── chat.ts                   # TypeScript interfaces for chat data
└── static/
    └── rag-icon.svg                  # Optional: chatbot icon
```

**Structure Decision**: Integrated React component within existing Docusaurus monorepo. ChatBot component placed in shared `components/` directory alongside existing Docusaurus components. Follows standard Docusaurus structure for maintainability and code reuse.

---

## High-Level Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                       DOCUSAURUS SITE                            │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │                    Book Content (Markdown)                  │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                   │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │          ChatBot Component (React)                          │  │
│  ├────────────────────────────────────────────────────────────┤  │
│  │ • Query input field                                         │  │
│  │ • Message history display                                  │  │
│  │ • Loading state + error handling                           │  │
│  │ • Source citations (clickable links)                       │  │
│  │ • Text selection capture (context menu)                    │  │
│  └────────────────────────────────────────────────────────────┘  │
│           ↓ HTTP POST /chat                                      │
└─────────────────────────────────────────────────────────────────┘
                         │
                         ↓
         ┌───────────────────────────────────┐
         │   FastAPI RAG Agent API (Spec 3)  │
         ├───────────────────────────────────┤
         │  GET  /health                     │
         │  POST /chat                       │
         │       Request: query, top_k,      │
         │                 retrieval_scope   │
         │       Response: answer, chunks,   │
         │                 sources, metrics  │
         ├───────────────────────────────────┤
         │  • Query embedding (Cohere)       │
         │  • Semantic search (Qdrant)       │
         │  • Agent execution (OpenAI)       │
         │  • Response grounding             │
         └───────────────────────────────────┘
```

---

## API Integration Strategy

### Communication Pattern

**Frontend → Backend**:
```json
{
  "query": "What is ROS2?",
  "retrieval_scope": "full_collection",
  "top_k": 5
}
```

**Backend → Frontend**:
```json
{
  "query": "What is ROS2?",
  "answer": "ROS2 is a flexible middleware...",
  "retrieved_chunks": [
    {
      "chunk_id": "chunk_123",
      "text": "...",
      "similarity_score": 0.92,
      "source_url": "https://...",
      "page_title": "Introduction to ROS2",
      "section_headers": ["Robotics", "ROS2 Basics"]
    }
  ],
  "execution_metrics": {
    "retrieval_time_ms": 245.3,
    "generation_time_ms": 2150.7,
    "total_time_ms": 2396.0
  },
  "retrieval_scope": "full_collection",
  "status": "success",
  "error": null
}
```

### Configuration

**Environment Variables** (Docusaurus build-time):
```env
# .env.local (development)
REACT_APP_RAG_AGENT_URL=http://localhost:8000

# .env.production
REACT_APP_RAG_AGENT_URL=https://api.example.com
```

**Fallback Default**: `http://localhost:8000/chat` (for development without env file)

### Error Handling

| Error Scenario | User Experience |
|---|---|
| Network unreachable | "Unable to connect. Check your internet." + Retry button |
| API timeout (>30s) | "Request took too long. Please try again." + Retry button |
| API error 500 | "Server error. Please try again later." |
| Empty query | Frontend validation: "Please enter a question." (prevents submission) |
| API rate limit | "Too many requests. Please wait a moment." |

---

## Text Selection Feature

### Implementation Approach

1. **Text Selection Detection**:
   - Listen for `mouseup` / `touchend` events on textbook content
   - Use `window.getSelection()` API to capture selected text
   - Show context menu near selection if text length > 5 characters

2. **Selection → Query**:
   - User clicks "Ask about this selection"
   - Chatbot opens with pre-filled prompt: "Explain this: [selected text]"
   - Selected text sent as part of query to backend

3. **Scoped Response**:
   - Backend receives full query with selected text context
   - RAG Agent generates response scoped to that selection
   - Response may include broader context if relevant

**Alternative**: Disallow in MVP if too complex; defer to Phase 2

---

## Design Decisions

### 1. Component Placement: Sidebar vs. Modal

**Decision**: Responsive layout
- **Desktop**: Fixed sidebar on right edge (persistent, can toggle)
- **Mobile**: Bottom sheet / slide-up modal (saves screen space)
- **Tablet**: Sidebar with reduced width

**Rationale**: Allows users on desktop to keep chatbot open while reading; mobile users get full screen real estate for book content.

### 2. Conversation History

**Decision**: Session-only (no localStorage)
- Messages stored in React state (component/context)
- Cleared on page reload or navigation away
- No server-side persistence

**Rationale**: Simplifies implementation (no backend changes); keeps scope small; users expect fresh chat per session.

**Alternative Considered**: localStorage persistence → deferred to P2 if needed

### 3. API Client Library

**Decision**: Native Fetch API + React hooks
- Use `useEffect` + `useState` for async state
- Optional: React Query/SWR for caching (deferred to Phase 2)

**Rationale**: Docusaurus projects are lightweight; avoid heavy dependencies. Fetch API is standard and performant.

### 4. Styling

**Decision**: Docusaurus CSS modules + Tailwind (if available)
- Use existing Docusaurus design tokens
- No custom design system
- Responsive out-of-the-box

**Rationale**: Consistency with existing site; minimal CSS to maintain.

---

## Risk Analysis

| Risk | Impact | Mitigation |
|------|--------|-----------|
| Backend API unreachable | Users can't use chatbot | Clear error message; docs explain setup |
| CORS issues (frontend ≠ backend domain) | Requests fail | Ensure FastAPI has proper CORS config |
| Large response > UI limit | Text overflows / breaks layout | Implement scrolling; truncate if needed |
| Network latency > 5s SLA | User sees timeout | Implement 30s frontend timeout + retry |
| Mobile: sidebar too wide | Unusable on small screens | Test on mobile; use bottom sheet instead |

---

## Non-Functional Requirements

| Requirement | Target | Method |
|---|---|---|
| Response Time | < 5 seconds | API SLA enforcement; loading state |
| Availability | 95%+ | Graceful degradation if API down |
| Browser Support | Chrome, Firefox, Safari, Edge | Standard React/ES2020 |
| Accessibility | WCAG 2.1 AA | Semantic HTML; keyboard navigation |
| Performance | 60 FPS UI interactions | React memo; no blocking ops |

---

## Rollout Strategy

### Phase 1: MVP (P1 Feature Only)
- ✅ Ask question about book content
- ✅ Display responses with sources
- ✅ Conversation history (session)
- ✅ Basic error handling
- ✅ Backend URL configuration

### Phase 2: Enhanced UX (P2 Feature)
- ✅ Text selection capture + "Ask about this"
- ✅ localStorage persistence (optional)
- ✅ Loading skeletons / animations
- ✅ Mobile optimization

### Phase 3: Polish (P3 + Beyond)
- ✅ Analytics / usage tracking
- ✅ Advanced styling / theming
- ✅ Multi-turn conversation context
- ✅ User feedback mechanisms

---

## Dependencies on Other Specs

- **Spec 1**: Website Ingestion Pipeline
  - Provides textbook content ingestion into Qdrant
  - Must be deployed and running for chatbot to function

- **Spec 2**: RAG Retrieval Validation
  - Validates semantic search quality
  - Ensures `/retrieve` endpoint works correctly

- **Spec 3**: RAG Agent API
  - Provides `/chat` endpoint that frontend calls
  - Must be deployed and accessible at configured URL
  - **Critical Dependency**: This feature depends on Spec 3 being operational

---

## Success Criteria Mapping

| Spec Criterion | How Validated in Implementation |
|---|---|
| SC-001: 5s response | Frontend measures time; shows timeout after 30s |
| SC-002: 95% API success | Monitor API health; graceful degradation on errors |
| SC-003: Multi-browser | Test on Chrome, Firefox, Safari, Edge |
| SC-004: Text selection works | Test on 90% of scenarios (bold, italics, code, etc.) |
| SC-005: URL configuration works | Test env vars for localhost and production URLs |
| SC-006: Session persistence | Verify history survives page nav; cleared on reload |
| SC-007: Error messaging | Check error appears within 2s of API failure |
| SC-008: 80% user success | Usability testing with target audience |

---

## Assumptions

1. **FastAPI is Deployed**: Spec 3 (RAG Agent API) is operational and accessible
2. **Qdrant has Content**: Spec 1 (Website Ingestion) has populated vector database
3. **CORS is Configured**: FastAPI has `CORSMiddleware` configured to allow frontend domain
4. **No Auth Required**: Chatbot API calls don't require authentication
5. **Standard Browser APIs**: Users have modern browsers with Fetch, Selection APIs
6. **React 18+ Available**: Docusaurus includes React 18+
7. **Node.js 16+**: Build environment has Node 16 or higher

---

## Open Questions for Research (Phase 0)

1. **CORS Configuration**: How should FastAPI CORS be configured for Docusaurus domain?
   - Task: Research CORS patterns for FastAPI + React
   - Current default: Docusaurus runs on `localhost:3000` in dev, `example.com` in prod

2. **Fetch vs. Axios**: Should we use native Fetch or axios library?
   - Task: Compare patterns; decide on HTTP client
   - Current default: Native Fetch (no extra dependency)

3. **State Management**: useState only, or use Context + useReducer for complex state?
   - Task: Research conversation state patterns
   - Current default: useState for MVP; Context for P2 if needed

4. **Text Selection UI**: Right-click context menu or floating toolbar?
   - Task: Research UX patterns for text selection
   - Current default: Context menu (simpler to implement)

5. **Mobile Experience**: Bottom sheet library (Headless UI? Radix?) or custom CSS?
   - Task: Evaluate mobile sheet libraries
   - Current default: Custom CSS (simpler; may revisit in P2)

---

## Next Steps

1. **Phase 0** (Research): Generate `research.md` with answers to open questions
2. **Phase 1** (Design): Create:
   - `data-model.md` (ChatMessage, RetrievedChunk entities)
   - `contracts/chatbot-api.openapi.yaml` (API schema)
   - `quickstart.md` (developer setup)
3. **Phase 2** (Tasks): Run `/sp.tasks` to generate executable task list